# Vision API + Gemini å›¾å±‚ç”Ÿæˆå·¥å…·

ä½¿ç”¨ Google Cloud Vision API å’Œ Gemini 3 Pro æ¨¡å‹ï¼Œé€šè¿‡äº”æ­¥æµç¨‹ç²¾ç¡®è¯†åˆ«å¹¶é‡å»ºå›¾ç‰‡ä¸­çš„æ–‡å­—å’Œå›¾å±‚ã€‚

## åŠŸèƒ½æ¦‚è¿°

æœ¬å·¥å…·é‡‡ç”¨**äº”æ­¥æµç¨‹**ï¼Œç»“åˆ Vision API çš„ç²¾ç¡®åæ ‡æ£€æµ‹ã€Gemini çš„è§†è§‰åˆ†æèƒ½åŠ›å’Œ Gemini Image çš„å›¾åƒç”Ÿæˆèƒ½åŠ›ï¼š

1. **Step 1: Vision API æ–‡å­—è¯†åˆ«** - è·å–ç²¾ç¡®çš„æ–‡å­—åæ ‡
2. **Step 2: Gemini åˆæ­¥åˆ†æ** - å‚è€ƒå­—ä½“æ ·å¼åº“ (textstyle.pdf) ç”Ÿæˆåˆæ­¥çš„ fabric.js JSONï¼ˆèƒŒæ™¯ã€å½¢çŠ¶ã€æ–‡å­—æ ·å¼ã€å­—ä½“ç±»å‹ï¼‰
3. **Step 3: Gemini æ•´åˆä¿®æ­£** - å°†å‰ä¸¤æ­¥ç»“æœ + åŸå›¾ä¸€èµ·é€ç»™ Gemini åšæœ€ç»ˆæ•´åˆ
4. **Step 4: Gemini Image ç§»é™¤æ–‡å­—** - ä½¿ç”¨ gemini-3-pro-image-preview ç§»é™¤åŸå›¾æ–‡å­—ï¼Œç”Ÿæˆå¹²å‡€çš„ base image
5. **Step 5: æ¸²æŸ“è¾“å‡º** - åœ¨ base image ä¸Šæ¸²æŸ“æ–°æ–‡å­—

## å‰ç½®è¦æ±‚

### 1. Google Cloud é¡¹ç›®é…ç½®

ç¡®ä¿æ‚¨å·²ç»ï¼š
- åˆ›å»ºäº† Google Cloud é¡¹ç›®
- å¯ç”¨äº† Cloud Vision API
- å¯ç”¨äº† Vertex AI API
- é…ç½®äº†èº«ä»½éªŒè¯

```bash
# è®¾ç½®é¡¹ç›® ID
export GOOGLE_CLOUD_PROJECT="your-project-id"
export GOOGLE_CLOUD_LOCATION="global"

# è®¾ç½® API Keyï¼ˆå¯é€‰ï¼Œå¦‚æœä½¿ç”¨ API Key è®¤è¯ï¼‰
export GOOGLE_CLOUD_API_KEY="your-api-key"

# ä½¿ç”¨ gcloud è¿›è¡Œèº«ä»½éªŒè¯
gcloud auth application-default login
```

### 2. å®‰è£…ä¾èµ–

```bash
cd /Users/sunnyfang/Documents/git/imagelayer
pip install -r requirements.txt
```

## ä½¿ç”¨æ–¹æ³•

### åŸºæœ¬ç”¨æ³•

```bash
# ä½¿ç”¨é»˜è®¤é…ç½®ï¼ˆåˆ†æ image/layer1.jpgï¼‰
python vision_to_fabric.py

# æŒ‡å®šè¾“å…¥å›¾ç‰‡
python vision_to_fabric.py -i myimage.jpg

# æŒ‡å®šæ‰€æœ‰è¾“å‡ºè·¯å¾„
python vision_to_fabric.py -i myimage.jpg -o result.jpg -b base.png -j final.json
```

### å‘½ä»¤è¡Œå‚æ•°

| å‚æ•° | çŸ­å‚æ•° | é»˜è®¤å€¼ | è¯´æ˜ |
|------|--------|--------|------|
| `--image` | `-i` | `layer1.jpg` | è¾“å…¥å›¾ç‰‡åç§°ï¼ˆæ”¾åœ¨ image/ ç›®å½•ä¸‹ï¼‰|
| `--output` | `-o` | `output.jpg` | è¾“å‡ºå›¾ç‰‡åç§° |
| `--base-output` | `-b` | `base_image.png` | **ç§»é™¤æ–‡å­—åçš„ base image** |
| `--json-output` | `-j` | `fabric_output.json` | æœ€ç»ˆ fabric.js JSON |
| `--vision-output` | `-v` | `vision_result.json` | Vision API ç»“æœ |
| `--initial-output` | - | `fabric_initial.json` | åˆæ­¥ fabric.js JSON |

## è¾“å‡ºæ–‡ä»¶

è¿è¡Œåä¼šåœ¨ `image/` ç›®å½•ä¸‹ç”Ÿæˆä»¥ä¸‹æ–‡ä»¶ï¼š

| æ–‡ä»¶ | è¯´æ˜ |
|------|------|
| `vision_result.json` | Vision API è¿”å›çš„æ–‡å­—åæ ‡ä¿¡æ¯ |
| `fabric_initial.json` | Gemini åˆæ­¥åˆ†æçš„ fabric.js JSON |
| `fabric_output.json` | **æœ€ç»ˆæ•´åˆä¿®æ­£åçš„ fabric.js JSON** |
| `base_image.png` | **Gemini Image ç”Ÿæˆçš„æ— æ–‡å­—å¹²å‡€å›¾ç‰‡** |
| `output.jpg` | æœ€ç»ˆæ¸²æŸ“çš„è¾“å‡ºå›¾ç‰‡ |

## äº”æ­¥æµç¨‹è¯¦è§£

### Step 1: Vision API æ–‡å­—è¯†åˆ«

ä½¿ç”¨ Google Cloud Vision API ç²¾ç¡®æ£€æµ‹å›¾ç‰‡ä¸­çš„æ–‡å­—å’Œåæ ‡ï¼š

```json
{
  "text_blocks": [
    {
      "text": "TEMU",
      "left": 234,
      "top": 56,
      "width": 122,
      "height": 31,
      "center_x": 295.0,
      "center_y": 71.5
    }
  ],
  "text_lines": [
    {
      "texts": ["TEMU", "HOME"],
      "full_text": "TEMU HOME",
      "unified_top": 56,
      "unified_height": 31
    }
  ]
}
```

**å…³é”®ç‰¹æ€§ï¼š**
- ç²¾ç¡®çš„è¾¹ç•Œæ¡†åæ ‡ (left, top, width, height)
- æŒ‰è¡Œåˆ†ç»„ (text_lines)ï¼Œç”¨äºæ–‡å­—å‚ç›´å¯¹é½

### Step 2: Gemini åˆæ­¥åˆ†æ + å­—ä½“åº“å‚è€ƒ

Gemini åˆ†æå›¾ç‰‡æ—¶ï¼Œä¼šåŒæ—¶å‚è€ƒ **å­—ä½“æ ·å¼åº“ (textstyle.pdf)** æ¥ç²¾ç¡®è¯†åˆ«å­—ä½“ç±»å‹ï¼š

**è¾“å…¥ï¼š**
- åŸå›¾
- å­—ä½“æ ·å¼å‚è€ƒæ–‡ä»¶ (`image/textstyle.pdf`)

**è¾“å‡ºï¼š**

```json
{
  "version": "5.3.0",
  "objects": [
    {"type": "rect", "left": 0, "top": 0, "width": 600, "height": 600, "fill": "#8B4513"},
    {
      "type": "textbox", 
      "text": "TEMU HOME", 
      "fontWeight": "bold", 
      "fontStyle": "normal",
      "fontFamily": "Sans-serif",
      "fill": "#FFFFFF"
    }
  ],
  "background": "#8B4513"
}
```

**å…³é”®ç‰¹æ€§ï¼š**
- èƒŒæ™¯é¢œè‰²è¯†åˆ«
- å½¢çŠ¶è¯†åˆ«ï¼ˆçŸ©å½¢ã€åœ†å½¢ç­‰ï¼‰
- æ–‡å­—æ ·å¼è¯†åˆ«ï¼ˆç²—ä½“ã€æ–œä½“ã€é¢œè‰²ï¼‰
- **å­—ä½“ç±»å‹è¯†åˆ«** - å‚è€ƒ textstyle.pdf å­—ä½“åº“ç²¾ç¡®åŒ¹é…ï¼ˆSerifã€Sans-serifã€Cursive ç­‰ï¼‰

> ğŸ’¡ **å­—ä½“åº“å‚è€ƒ**ï¼š`image/textstyle.pdf` åŒ…å«å¸¸ç”¨å­—ä½“çš„æ ·å¼æŒ‡å—ï¼ŒGemini ä¼šå¯¹æ¯”å›¾ç‰‡ä¸­çš„æ–‡å­—ä¸å­—ä½“åº“æ¥åˆ¤æ–­å­—ä½“ç±»å‹ã€‚

### Step 3: Gemini æ•´åˆä¿®æ­£

**æ ¸å¿ƒæ­¥éª¤**ï¼šå°† Vision API ç»“æœ + åˆæ­¥ fabric.js + åŸå›¾ä¸€èµ·å‘é€ç»™ Geminiï¼Œè¿›è¡Œæœ€ç»ˆæ•´åˆï¼š

**æ•´åˆè§„åˆ™ï¼š**
1. **æ–‡å­—åæ ‡** â†’ ä½¿ç”¨ Vision API çš„ç²¾ç¡®åæ ‡
2. **æ–‡å­—æ ·å¼** â†’ ä½¿ç”¨ Gemini åˆ†æçš„æ ·å¼ï¼ˆfontWeight, fontStyle, fontFamily, fillï¼‰
3. **åŒè¡Œæ–‡å­—** â†’ ä½¿ç”¨ unified_top ç¡®ä¿å‚ç›´å¯¹é½
4. **èƒŒæ™¯/å½¢çŠ¶** â†’ ä½¿ç”¨ Gemini åˆ†æçš„ç»“æœ

```json
{
  "type": "textbox",
  "text": "TEMU",
  "left": 234,           // â† æ¥è‡ª Vision API
  "top": 56,             // â† æ¥è‡ª Vision API
  "width": 122,          // â† æ¥è‡ª Vision API
  "height": 31,          // â† æ¥è‡ª Vision API
  "fontWeight": "bold",  // â† æ¥è‡ª Gemini åˆ†æ
  "fontStyle": "normal", // â† æ¥è‡ª Gemini åˆ†æ
  "fontFamily": "Serif", // â† æ¥è‡ª Gemini åˆ†æ
  "fill": "#FFFFFF"      // â† æ¥è‡ª Gemini åˆ†æ
}
```

### Step 4: Gemini Image ç§»é™¤æ–‡å­— (æ–°åŠŸèƒ½)

ä½¿ç”¨ **gemini-3-pro-image-preview** æ¨¡å‹ç§»é™¤åŸå›¾ä¸­çš„æ‰€æœ‰æ–‡å­—ï¼Œç”Ÿæˆå¹²å‡€çš„ base imageï¼š

```python
prompt = """Please remove ALL text and words from this image. 
Keep the product, background, and all other visual elements intact.
Only remove the text overlays, logos with text, and any written words.
The result should be a clean image without any text."""
```

**ä¼˜åŠ¿ï¼š**
- æ¯”ç®€å•çš„é¢œè‰²è¦†ç›–æ•ˆæœæ›´è‡ªç„¶
- ä¿ç•™å•†å“å’ŒèƒŒæ™¯çš„å®Œæ•´æ€§
- é¿å…æ–‡å­—é‡å é—®é¢˜

### Step 5: æ¸²æŸ“è¾“å‡º

åœ¨ base image ä¸Šæ¸²æŸ“æ–°æ–‡å­—å’Œå½¢çŠ¶ï¼š

- è‡ªåŠ¨è®¡ç®—åæ ‡ç¼©æ”¾æ¯”ä¾‹ï¼ˆå¦‚æœ base image å°ºå¯¸ä¸åŸå›¾ä¸åŒï¼‰
- æ”¯æŒå¤šç§å­—ä½“ç±»å‹ï¼ˆSerifã€Sans-serifã€Cursive ç­‰ï¼‰
- æ”¯æŒç²—ä½“ã€æ–œä½“æ ·å¼

## å·¥ä½œæµç¨‹å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     è¾“å…¥å›¾ç‰‡      â”‚
â”‚  (image/*.jpg)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                                          â”‚
         â–¼                                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Step 1         â”‚                    â”‚   Step 2         â”‚
â”‚   Vision API     â”‚                    â”‚   Gemini åˆæ­¥    â”‚
â”‚   æ–‡å­—åæ ‡è¯†åˆ«    â”‚                    â”‚   å›¾å±‚åˆ†æ       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚ + textstyle.pdf  â”‚
         â”‚                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚  vision_result.json                   â”‚  fabric_initial.json
         â”‚                                       â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚   Step 3         â”‚
              â”‚   Gemini æ•´åˆ    â”‚  â—„â”€â”€â”€ + åŸå›¾
              â”‚   ä¿®æ­£åæ ‡       â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â”‚  fabric_output.json
                       â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                           â”‚
         â–¼                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Step 4         â”‚      â”‚   fabric.js      â”‚
â”‚   Gemini Image   â”‚      â”‚   JSON æ•°æ®      â”‚
â”‚   ç§»é™¤æ–‡å­—       â”‚      â”‚                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                         â”‚
         â”‚  base_image.png         â”‚
         â”‚                         â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚   Step 5         â”‚
          â”‚   æ¸²æŸ“æ–‡å­—       â”‚
          â”‚   åˆ° base image  â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚   è¾“å‡ºå›¾ç‰‡        â”‚
          â”‚   output.jpg     â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## å­—ä½“è¯†åˆ«æŒ‡å—

Gemini ä¼šæ ¹æ®ä»¥ä¸‹ç‰¹å¾è¯†åˆ«å­—ä½“ç±»å‹ï¼š

### Serif è¡¬çº¿å­—ä½“
- **ç‰¹å¾**: å­—æ¯æœ«ç«¯æœ‰å°çš„æ¨ªçº¿æˆ–è£…é¥°
- **ç¤ºä¾‹**: Times New Roman, Georgia, Garamond
- **æ¸²æŸ“å­—ä½“**: Times New Roman

### Sans-serif æ— è¡¬çº¿å­—ä½“
- **ç‰¹å¾**: å­—æ¯æœ«ç«¯æ²¡æœ‰è£…é¥°ï¼Œçº¿æ¡å‡åŒ€
- **ç¤ºä¾‹**: Arial, Helvetica, Verdana
- **æ¸²æŸ“å­—ä½“**: Arial

### Cursive æ‰‹å†™ä½“
- **ç‰¹å¾**: æ¨¡ä»¿æ‰‹å†™ï¼Œæœ‰è¿ç¬”æˆ–ä¹¦æ³•é£æ ¼
- **ç¤ºä¾‹**: Brush Script, Pacifico
- **æ¸²æŸ“å­—ä½“**: Brush Script

## ä¸ºä»€ä¹ˆä½¿ç”¨äº”æ­¥æµç¨‹ï¼Ÿ

| é—®é¢˜ | è§£å†³æ–¹æ¡ˆ |
|------|----------|
| Gemini å•ç‹¬åˆ†ææ—¶åæ ‡ä¸å¤Ÿç²¾ç¡® | Step 1: Vision API æä¾›ç²¾ç¡®åæ ‡ |
| Vision API ä¸æä¾›å­—ä½“æ ·å¼ä¿¡æ¯ | Step 2: Gemini åˆ†æå­—ä½“æ ·å¼å’Œç±»å‹ |
| éœ€è¦åŒæ—¶åˆ©ç”¨ä¸¤è€…çš„ä¼˜åŠ¿ | Step 3: Gemini æ•´åˆä¸¤ä¸ªæ•°æ®æº |
| ç®€å•é¢œè‰²è¦†ç›–ä¸å¤Ÿè‡ªç„¶ | Step 4: Gemini Image æ™ºèƒ½ç§»é™¤æ–‡å­— |
| éœ€è¦å¤„ç†å°ºå¯¸å·®å¼‚ | Step 5: è‡ªåŠ¨åæ ‡ç¼©æ”¾æ¸²æŸ“ |

## å¤‡ç”¨æ–¹æ¡ˆ

å¦‚æœ Step 4 (Gemini Image) å¤±è´¥ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨ä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆï¼š
- ä½¿ç”¨åŸå›¾ä½œä¸ºèƒŒæ™¯
- ç”¨å‘¨å›´é¢œè‰²è¦†ç›–åŸæ–‡å­—åŒºåŸŸ
- æ¸²æŸ“æ–°æ–‡å­—

## æ³¨æ„äº‹é¡¹

1. **API é…é¢**: Vision APIã€Vertex AI å’Œ Gemini Image éƒ½æœ‰ä½¿ç”¨é…é¢é™åˆ¶
2. **å›¾ç‰‡æ ¼å¼**: æ”¯æŒ JPEGã€PNGã€GIFã€WebP æ ¼å¼
3. **æ–‡å­—è¯†åˆ«**: Vision API å¯¹æ¸…æ™°ã€é«˜å¯¹æ¯”åº¦çš„æ–‡å­—æ•ˆæœæ›´å¥½
4. **å­—ä½“æ¸²æŸ“**: ä½¿ç”¨ç³»ç»Ÿå­—ä½“ï¼ˆmacOSï¼‰ï¼Œå¯èƒ½ä¸åŸå›¾å­—ä½“æœ‰å·®å¼‚
5. **å›¾ç‰‡ç›®å½•**: å›¾ç‰‡éœ€è¦æ”¾åœ¨ `image/` å­ç›®å½•ä¸‹
6. **å°ºå¯¸å·®å¼‚**: Gemini Image ç”Ÿæˆçš„ base image å¯èƒ½ä¸åŸå›¾å°ºå¯¸ä¸åŒï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨ç¼©æ”¾

## æ•…éšœæ’é™¤

### è®¤è¯é”™è¯¯

```bash
# é‡æ–°è¿›è¡Œèº«ä»½éªŒè¯
gcloud auth application-default login
```

### ç¼ºå°‘ API æƒé™

```bash
# å¯ç”¨å¿…è¦çš„ API
gcloud services enable vision.googleapis.com
gcloud services enable aiplatform.googleapis.com
```

### Gemini Image ç”Ÿæˆå¤±è´¥

å¦‚æœ Step 4 å¤±è´¥ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨ä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆã€‚å¯èƒ½çš„åŸå› ï¼š
- API é…é¢ç”¨å°½
- æ¨¡å‹æš‚æ—¶ä¸å¯ç”¨
- å›¾ç‰‡å†…å®¹è§¦å‘å®‰å…¨è¿‡æ»¤

### å›¾ç‰‡æ–‡ä»¶ä¸å­˜åœ¨

ç¡®ä¿å›¾ç‰‡æ”¾åœ¨ `imagelayer/image/` ç›®å½•ä¸‹ï¼š

```bash
ls imagelayer/image/
# åº”è¯¥çœ‹åˆ° layer1.jpg æˆ–å…¶ä»–å›¾ç‰‡æ–‡ä»¶
```

### æ¨¡å—æœªæ‰¾åˆ°

```bash
# é‡æ–°å®‰è£…ä¾èµ–
pip install -r requirements.txt --upgrade
```

## ç‰ˆæœ¬å†å²

### v2.0 (å½“å‰ç‰ˆæœ¬)
- æ–°å¢ Step 4: Gemini Image ç§»é™¤æ–‡å­—
- æ–°å¢ Step 5: åœ¨ base image ä¸Šæ¸²æŸ“
- å¢å¼ºå­—ä½“è¯†åˆ«ï¼ˆæ”¯æŒ Serifã€Sans-serifã€Cursive ç­‰ï¼‰
- è‡ªåŠ¨åæ ‡ç¼©æ”¾æ”¯æŒ

### v1.0
- åˆå§‹ç‰ˆæœ¬
- ä¸‰æ­¥æµç¨‹ï¼šVision API + Gemini åˆ†æ + æ•´åˆæ¸²æŸ“

## è®¸å¯è¯

MIT License
